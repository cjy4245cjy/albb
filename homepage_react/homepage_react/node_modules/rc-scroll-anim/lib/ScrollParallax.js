'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _EventDispatcher = require('./EventDispatcher');

var _EventDispatcher2 = _interopRequireDefault(_EventDispatcher);

var _tweenFunctions = require('tween-functions');

var _tweenFunctions2 = _interopRequireDefault(_tweenFunctions);

var _TimeLine = require('rc-tween-one/lib/TimeLine');

var _TimeLine2 = _interopRequireDefault(_TimeLine);

var _ticker = require('rc-tween-one/lib/ticker');

var _ticker2 = _interopRequireDefault(_ticker);

var _util = require('./util');

var _Mapped = require('./Mapped');

var _Mapped2 = _interopRequireDefault(_Mapped);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defaults(obj, defaults) { var keys = Object.getOwnPropertyNames(defaults); for (var i = 0; i < keys.length; i++) { var key = keys[i]; var value = Object.getOwnPropertyDescriptor(defaults, key); if (value && value.configurable && obj[key] === undefined) { Object.defineProperty(obj, key, value); } } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : _defaults(subClass, superClass); }

var tickerId = 0;

function noop() {}

function playScaleToArray(playScale) {
  if (Array.isArray(playScale)) {
    if (playScale.length === 2) {
      return playScale;
    }
    return [playScale[0] || 0, playScale[1] || 1];
  } else if (playScale) {
    return [playScale, 1];
  }
  return [0, 1];
}

var ScrollParallax = function (_React$Component) {
  _inherits(ScrollParallax, _React$Component);

  function ScrollParallax() {
    _classCallCheck(this, ScrollParallax);

    var _this = _possibleConstructorReturn(this, _React$Component.apply(this, arguments));

    _this.scrollTop = 0;
    _this.defaultTweenData = [];
    _this.defaultData = [];
    _this.state = {};
    ['scrollEventListener'].forEach(function (method) {
      return _this[method] = _this[method].bind(_this);
    });
    return _this;
  }

  ScrollParallax.prototype.componentDidMount = function componentDidMount() {
    var _this2 = this;

    this.dom = _reactDom2["default"].findDOMNode(this);
    if (this.props.scrollName) {
      _Mapped2["default"].register(this.props.scrollName, this.dom);
    }
    this.scrollTop = (0, _util.currentScrollTop)();
    this.clientHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    this.setDefaultData(this.props.animation || {});

    // 第一次进入;
    setTimeout(function () {
      _this2.timeline = new _TimeLine2["default"](_this2.dom, _this2.defaultTweenData);
      _this2.scrollEventListener();
      var date = Date.now();
      var length = _EventDispatcher2["default"]._listeners.scroll ? _EventDispatcher2["default"]._listeners.scroll.length : 0;
      _this2.eventType = 'scroll.scrollEvent' + date + length;
      _EventDispatcher2["default"].addEventListener(_this2.eventType, _this2.scrollEventListener);
    });
  };

  ScrollParallax.prototype.componentWillReceiveProps = function componentWillReceiveProps(nextProps) {
    var equal = (0, _util.objectEqual)(this.props.animation, nextProps.animation);
    if (!equal) {
      this.setDefaultData(nextProps.animation || {});
      this.timeline.resetAnimData();
      this.timeline.setDefaultData(this.defaultTweenData);
    }
  };

  ScrollParallax.prototype.componentWillUnmount = function componentWillUnmount() {
    _Mapped2["default"].unRegister(this.props.scrollName);
    _EventDispatcher2["default"].removeEventListener(this.eventType, this.scrollEventListener);
  };

  ScrollParallax.prototype.setDefaultData = function setDefaultData(_vars) {
    var _this3 = this;

    var vars = (0, _util.dataToArray)(_vars);
    var varsForIn = function varsForIn(item, i) {
      var playScale = playScaleToArray(item.playScale).map(function (data) {
        return data * _this3.clientHeight;
      });
      var __item = _extends({}, item);
      delete __item.playScale;
      var _item = _extends({}, item);
      delete _item.playScale;
      _item.delay = __item.delay = playScale[0];
      _item.duration = __item.duration = playScale[1] - playScale[0];
      _item.onStart = null;
      _item.onUpdate = null;
      _item.onComplete = null;
      _item.onRepeat = null;
      __item.onStart = __item.onStart || noop;
      __item.onComplete = __item.onComplete || noop;
      _this3.defaultTweenData[i] = _item;
      _this3.defaultData[i] = __item;
    };
    vars.forEach(varsForIn);
  };

  ScrollParallax.prototype.scrollEventListener = function scrollEventListener() {
    var _this4 = this;

    var scrollTop = (0, _util.currentScrollTop)();
    this.clientHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    var dom = this.props.location ? _Mapped2["default"].get(this.props.location) : this.dom;
    if (!dom) {
      throw new Error('"location" is null');
    }
    var offsetTop = dom.getBoundingClientRect().top + scrollTop;
    var elementShowHeight = scrollTop - offsetTop + this.clientHeight;
    var currentShow = this.scrollTop - offsetTop + this.clientHeight;
    var scrollTopValue = scrollTop - this.scrollTop;
    this.defaultData.forEach(function (item) {
      if (scrollTopValue > 0 && elementShowHeight < item.delay || scrollTopValue < 0 && elementShowHeight > item.delay) {
        item.onStart.only = false;
      }
      if ((elementShowHeight >= item.delay && currentShow <= item.delay && scrollTopValue > 0 || elementShowHeight <= item.delay && currentShow >= item.delay && scrollTopValue < 0) && !item.onStart.only) {
        item.onStart.only = true;
        item.onStart();
      }
      var time = item.delay + item.duration;
      if (scrollTopValue > 0 && elementShowHeight < time || scrollTopValue < 0 && elementShowHeight > time) {
        item.onComplete.only = false;
      }
      if (!item.onComplete.only && (elementShowHeight >= time && currentShow <= time && scrollTopValue > 0 || elementShowHeight <= time && currentShow >= time && scrollTopValue < 0)) {
        item.onComplete();
        item.onComplete.only = true;
      }
    });
    _ticker2["default"].clear(this.tickerId);
    this.tickerId = 'scrollParallax' + Date.now() + '-' + tickerId;
    tickerId++;
    if (tickerId >= Number.MAX_VALUE) {
      tickerId = 0;
    }
    var startFrame = _ticker2["default"].frame;
    _ticker2["default"].wake(this.tickerId, function () {
      var moment = (_ticker2["default"].frame - startFrame) * _ticker2["default"].perFrame;
      var ratio = _tweenFunctions2["default"].easeOutQuad(moment, 0.08, 1, 300);
      _this4.timeline.frame(currentShow + ratio * (elementShowHeight - currentShow));
      if (moment >= 300) {
        _ticker2["default"].clear(_this4.tickerId);
      }
    });

    this.scrollTop = scrollTop;
    // 如果不一直靠滚动来执行动画，always=false而且动画全执行完了，，删除scrollEvent;
    if (this.defaultData.every(function (c) {
      return c.onComplete.only;
    }) && !this.props.always) {
      _EventDispatcher2["default"].removeEventListener(this.eventType, this.scrollEventListener);
    }
  };

  ScrollParallax.prototype.render = function render() {
    var props = _extends({}, this.props);
    ['animation', 'always', 'component', 'location', 'scrollName'].forEach(function (key) {
      return delete props[key];
    });
    var style = _extends({}, props.style);
    for (var p in style) {
      if (p.indexOf('filter') >= 0 || p.indexOf('Filter') >= 0) {
        // ['Webkit', 'Moz', 'Ms', 'ms'].forEach(prefix=> style[`${prefix}Filter`] = style[p]);
        var transformArr = ['Webkit', 'Moz', 'Ms', 'ms'];
        for (var i = 0; i < transformArr.length; i++) {
          style[transformArr[i] + 'Filter'] = style[p];
        }
      }
    }
    props.style = style;
    return _react2["default"].createElement(this.props.component, props);
  };

  return ScrollParallax;
}(_react2["default"].Component);

var objectOrArray = _react2["default"].PropTypes.oneOfType([_react2["default"].PropTypes.object, _react2["default"].PropTypes.array]);
var childPropTypes = _react2["default"].PropTypes.oneOfType([objectOrArray, _react2["default"].PropTypes.string]);
ScrollParallax.propTypes = {
  component: _react2["default"].PropTypes.string,
  animation: objectOrArray,
  always: _react2["default"].PropTypes.bool,
  location: _react2["default"].PropTypes.string,
  children: childPropTypes,
  className: _react2["default"].PropTypes.string,
  style: objectOrArray,
  scrollName: _react2["default"].PropTypes.string
};

ScrollParallax.defaultProps = {
  component: 'div',
  always: true
};

exports["default"] = ScrollParallax;
module.exports = exports['default'];